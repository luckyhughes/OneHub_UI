<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="http://code.jquery.com/jquery-1.9.1.js" type="text/javascript"></script>
<script src="http://code.highcharts.com/highcharts.js" type="text/javascript"></script>
<script src="http://code.highcharts.com/modules/exporting.js" type="text/javascript"></script>
<script src="http://underscorejs.org/underscore-min.js" type="text/javascript"></script>

  <script type="text/javascript">
    $(document).ready(function()
    {
		$('button').click(function() {

    	$.ajaxSetup( { "async": false } );

    	//pass query to generate data and div id as where to display.
    	plotchart("select * from AggregateMetrics where time > now() - 1000000000s limit 1","avg_response");
    	//plotchart([formattedForGraph[1]],"network_throughput");

    	$.ajaxSetup( { "async": true } );
		});

    });
 </script>
 
 <script>

 function getJsonData(query)
 {
	 var url = "http://54.68.127.15:8086/db/performance/series?u=root&p=root&q="+ query;

	 var highchartJson =[];
	 var sortedJson;

		console.log("ulr is:" + url);

		$.getJSON(url, function(jsondata) {

			if(jsondata.length>0){

				for (var i = 0; i < jsondata[0].columns.length; i++) {
					
						var seriesToPlot = {
						name : jsondata[0].columns[i],
						data : []
					};
					for (var j = 0; j < jsondata[0].points.length; j++) {
						seriesToPlot.data.push(jsondata[0].points[j][i]);
					}
					
					highchartJson.push(seriesToPlot);
				}
			}	

		});

		sortedJson = _.sortBy(highchartJson, 'name');
		//console.log(sortedJson);
		return sortedJson;
 }

function parseEpochTime(epoch)
{
	  var time=[];
	  var offset = (new Date).getTimezoneOffset()*60000;

		for(var i=0;i<epoch.length;i++)
		{
	     var date=new Date(epoch[i] - offset); //get offset for local timezone and convert epoch time to localtime zone

	     time.push(date.getHours()+":"+date.getMinutes()+":"+date.getSeconds());
	  	}
	return time;
}

	function plotchart(query,divid){

		//divid = '#'+divid;
		console.log(divid);
		var chart;

		//get highchart json data in name and data format from server to initialize seriesdata
	    var seriesdata = getJsonData(query);
	
		chart = new Highcharts.Chart({
				
					chart: {
					renderTo: divid,
	                type: 'spline',
	                animation: Highcharts.svg,
	                marginRight: 10,
	                events: {
	                    load: function () {

	                        var counter=0;
	                        var xseries=this.xAxis[0].categories;
	                    	var yseries = this.series;
	                    	console.log(yseries);

	                    	//extract timeseries only data from the seriesdataList in human readable format.
	                    	if(seriesdata.length>0){
								timeSeries=parseEpochTime(seriesdata[0].data);

								//push initial x axis data in categories
								xseries.push(timeSeries);
							}

							setInterval(function () {
								
								$.ajaxSetup( { "async": false } );

								//get highchart json data in name and data format from server
	                    		seriesdata = getJsonData(query);

	                    		if(seriesdata.length>0){

		                    		//extract timeseries only data from the seriesdataList in human readable format.
									timeSeries=parseEpochTime(seriesdata[0].data);
									
									//logic to update xaxis timeseries data on chart every minute considering interval is 5 sec (5*12)
									counter++;
		                            if(counter%12==0)
										xseries.push(timeSeries);
									else
										xseries.push("");
									
									//append series data with data points for respective series
									for ( i=0; i<seriesdata.length; i++) {
									
		                                datapoints =  seriesdata[i].data;

										//shift y series if dataponits are more than a value (20)
		                            	shift = yseries[i].data.length > 20;

		                            	yseries[i].addPoint(datapoints, true, shift);
		                        	}
		                        }	
							
	                        },3000);
	                      }
	                    }
	                },

					title : {
						text : 'Performance Heath'
					},

					xAxis: {
                		type: 'datetime',
                		//tickPixelInterval: 100,
						categories: [],
            		},

            		yAxis: {
                		title: {
                    	text: 'Value'
                	},
                	plotLines: [{
                    	value: 0,
                    	width: 1,
                    	color: '#808080'
                		}]
            		},

					tooltip : {
						valueSuffix : ''
					},
					legend : {
						layout : 'vertical',
						align : 'right',
						verticalAlign : 'middle',
						borderWidth : 0
					},

					series : seriesdata
				});
			
		}
	</script>
    
 </head>  

<body>
	
	<button>Show Graph</button>
	
	
	 <div id="avg_response" style="min-width: 400px; height: 300px; margin: 0 auto"></div>
	 
	 <div id="network_throughput" style="min-width: 400px; height: 300px; margin: 0 auto"></div>
	 
	 <div id="sample_summary" style="min-width: 400px; height: 300px; margin: 0 auto"></div>
	
</body>
</html>
